pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
#include helpfuncs.lua
#include entities.lua
#include room.lua
#include dungeon.lua


_ents = {}
_ents.Player = create_entity(0, 0, 0)

_ents.Player.update = function(self, ticks)

end

_ents.Player.draw = function(self, ticks)
    spr(self.sprite, self.x*8, self.y*8)
end

-- MAIN GAME FUNCTIONS 

function _init()
    level = Dungeon.new(16, 16)
    level:initMap()
    level:generateRooms()
    local root = level:getRoomTree()
    level:buildCorridors(root)
    level:addStaircases(2)
    
    --level:printMap()

    _ents.Player.y = level.start.y
    _ents.Player.x = level.start.x

    level:renderToMap(_ents.Player.y, _ents.Player.x)
end

function _update60()
    entities_update()

    if btnp(0) then -- left 
        if level:getTile(_ents.Player.y, _ents.Player.x-1).class&0x20 != 0x20 then
            _ents.Player.x -= 1
            moved = true
        end
    elseif btnp(1) then -- right
        if level:getTile(_ents.Player.y, _ents.Player.x+1).class&0x20 != 0x20 then
            _ents.Player.x += 1
            moved = true
        end
    elseif btnp(2) then -- up
        if level:getTile(_ents.Player.y-1, _ents.Player.x).class&0x20 != 0x20 then
            _ents.Player.y -= 1
            moved = true
        end
    elseif btnp(3) then
        if level:getTile(_ents.Player.y+1, _ents.Player.x).class&0x20 != 0x20 then
            _ents.Player.y += 1
            moved = true
        end
    else
        moved = false
    end
end


function _draw()
    cls()
    if moved then
        level:renderToMap(_ents.Player.y, _ents.Player.x) 
    end
    
    map(0, 0, 0, 0, 32,32)

    level:RenderVisibilityMap()
    pset(_ents.Player.x*1, _ents.Player.y*1, 10)
    --_ents.Player:draw(0)
    entities_draw()
end

-->8
-- Shading effects
function shader(sx, sy)
    for s=sy, sx+32 do
        for c=sx, sx+32 do
            --local dp = poke()
        end
    end
end


__gfx__
000155000001550000155000000000000000000055d5565555551515555555551111111100000000000000000000000000000000000000000000000000000000
00015a0000015a000015a00000000000000000005000000650000005551115551100011100000000000000000000000000000000000010000000000000000000
00d75500001566650d75500000000000000000005071000610000005556655651155115100110010000000000000000000000000000050000000000000000000
041566600046ccc60159650000000000000000005066100650000005555511551111001100000000000000000000000000000000000150000000000000000000
00425cc60446ccc60929aaaa00000000000000005066610650000005555165551110511100001000000000000000000000030000000550000000000000000000
04295c6600956cc60559c55000000000000000005066660610000001516511551051001100100000000000000000000030300000000510000000000000000000
0556a66001a56c655555650000000000000000005000000650000005551155651100151100000100000000000000000003000000000500000000000000000000
55555a6001a55660555655000000000000000000d565666655555551555555551111111100000000000000000000000003000000000100000000000000000000
000d5000000d5000000d500000051000000510000005500000011000000110000001100000000000000000000000000001001015010010100100101000000000
0051150000511500005555000011110000111100005115000010010000100100001001000000000000000000000000000001015d000101110001011100000000
0d111150051111500551155005111110011111100510015001000010010000100100001000000000000000000000000001001015010010100100101000000000
511d5115d1111115551001551115111151111111110000151000000110000001100000010000000000000000000000000001015d000101110001011100000000
51155115511111155510015511111111111111111100001510000001100000011000000100000000000000000000000001001015010010100100101000000000
0511115005111150055115500111111001111110051001500100001001000010010000100000000000000000000000000001015d000101110001011100000000
005115000051150000555d0000111100001111000051150000100100001001000010010000000000000000000000000001001015010010100100101000000000
0005500000055000000550000001100000011000000550000001100000011000000110000000000000000000000000000001015d000101110001011100000000
0000500000005000000050000000100000001000000050000000500000005000400d50012005500210055004200d500220055004200d5002100d500220055004
00001000000010000000100000001000000010000010101000001000010010000051110000d1150000d111000051150000d1150000d115000051110000d11500
00001000000000000000100000000000000010000000000000001000000000000511115005111150051001500511115005111150015001500511115005111150
11d5115100515010115511510051501055d51155005151101155115100515010d111d115d11001115100001551151115d1100115d1000015d111d115d1100111
00005000000010000000d00000011000000050000000100000001000000110005115111551100115510000155115511551100115510000155115111551100115
000050000000100000005000001010000000500000001010000010000010100005111150051111d0051001d005111150051111500510015005111150051111d0
000010000000100001001000000010000000100000101000010010000000100000111504005115000051150401511d0000111500005115040011150000511500
00001000000000001000100000000000000050000000000010001000000000002005500220055002100550022005500121055002200550022005500220055002
00001000000010000000100000001000000110000001100000011000000110000005100000010000000510000000000000000000000000000000000000000000
00001000000010000000100000001000001001000000010000000100001001000101501000001000010150100000000000000000000000000000000000000000
0000100000000000000010000000100000010010010000100100001001100000001511000001000000d511000000000000000000000000000000000000000000
11110111001110101110011101100001100000001000000110000001100000015151115110101010515111d10000000000000000000000000000000000000000
00001000000010000000100000000000100000011001000100000001100000011511151501010101150115150000000000000000000000000000000000000000
00001000000010000000100000000000010000100100001000000010010000100011510000001000051151000000000000000000000000000000000000000000
00001000000010000100100000001000001001000010000000100100001001000105101000010000010510100000000000000000000000000000000000000000
00001000000000001000100000000000000110000001100000011000000110000001500000001000000150000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000006006000600600070000007000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000007007000700700007000070075555700000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000007667000766700007755770757877570000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000007877000787700000787700000770000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000760000077500000077000000990000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000007767700a977000000099000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000006677000067000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000770000077700000000000000000000000000000000000000000000000000000000000
0556666666677550000000000000000000000000011111110000000000570d0000570d000000000000040000000978800000000029a2000004a0000003000000
56646111663636750000000000000000000000001133333300000000055705d0055705d00000000000090000000297980000000024900000494a00003bb00000
6644666166666667000000000011110000000000133ccccc00110010055705500557055000000000004940000000827800000000024000002949000033300000
646461116666666600000000001331000000000013cc3ccc000000005557055d5557055d00000000499799400000029800000000002000000224000003000000
626461666666666600000000001331000000000013cccccc00001000550000555549945500000000004940000000089800000000000000000000000000000000
626661116666666600000000001131000000000013ccc3cc001000005082280558a22a8500000000000900000000828000000000000000000000000000000000
642666666666664600000000000011000000000013cccc7c00000100505555055095590500000000000400000002280000000000000000000000000000000000
642666666666664600000000000000000000000013cccccc00000000000000000000000000000000000000000008200000000000000000000000000000000000
6466666c16666646000000000000000000000000000c100000000000000000005151151d00000000000000000000000055660000556600005566000055660000
646666c16661664611100000000000000000000000c10001000000000000000005571550000000000004000000000000d31d0000db3d0000d33d0000d33d0000
626661c166c6662622110000000000000000000001c100c0000000000000000000575500000000000009000000000000db3d0000dbbd0000db3d0000d33d0000
626661c16716662633311000000000000000000001c10710000000000000000000570505000000000497940000000000dddd0000dddd0000dddd0000dddd0000
626661c16716662642211000000000000000000001c1071000000000000000005057000000000000000900000000000000000000000000000000000000000000
626661c166c6662655111000000000000000000001c100c000000000000000000050050000000000000400000000000000000000000000000000000000000000
626666c16661662666d51000000000000000000000c1000100000000000000000050000000000000000000000000000000000000000000000000000000000000
6266666c16666626776d10000000000000000000000c100000000000000000000050000000000000000000000000000000000000000000000000000000000000
62666666666666268822100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
646666666666664694221000000000000000000000000000000000000000000000000000000000000000000000000000000c1000000000000000000000000000
6466666666666646a94210000000000000000000000000000000000000000000000000000000000000040000000000000cc11110000000000000000000000000
6266666666666666bb3310000000000000000000000000000000000000000000000000000000000000494000000000000ce11e10000000000000000000000000
6461111166666666ccd5100000000000000000000000000000000000000000000000000000000000000400000000000000c11100000000000000000000000000
6461666166666666dd511000000000000000000000000000000000000000000000000000000000000000000000000000000cc000000000000000000000000000
5661616166111665ee42100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0556666666666550f942100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
