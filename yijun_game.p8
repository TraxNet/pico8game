pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
#include helpfuncs.lua
#include entities.lua
#include room.lua
#include dungeon.lua


_entities = {}
_entities.Player = create_entity(0, 0, 0)

_entities.Player.update = function(self, ticks)

end

_entities.Player.draw = function(self, ticks)
    spr(self.sprite, self.x*8, self.y*8)
end

-- MAIN GAME FUNCTIONS 

function _init()
    level = Dungeon.new(16, 16)
    level:initMap()
    level:generateRooms()
    local root = level:getRoomTree()
    level:buildCorridors(root)
    level:addStaircases(2)
    --level:computeVisibility()
    
    level:printMap()

    _entities.Player.y = level.startPosition.y
    _entities.Player.x = level.startPosition.x

    level:renderToMap(_entities.Player.y, _entities.Player.x)
end

function _update60()
    entities_update()

    if btnp(0) then -- left 
        if level:getTile(_entities.Player.y, _entities.Player.x-1).class&0x20 != 0x20 then
            _entities.Player.x -= 1
            moved = true
        end
    elseif btnp(1) then -- right
        if level:getTile(_entities.Player.y, _entities.Player.x+1).class&0x20 != 0x20 then
            _entities.Player.x += 1
            moved = true
        end
    elseif btnp(2) then -- up
        if level:getTile(_entities.Player.y-1, _entities.Player.x).class&0x20 != 0x20 then
            _entities.Player.y -= 1
            moved = true
        end
    elseif btnp(3) then
        if level:getTile(_entities.Player.y+1, _entities.Player.x).class&0x20 != 0x20 then
            _entities.Player.y += 1
            moved = true
        end
    else
        moved = false
    end
end


function _draw()
    cls()
    if moved then
        level:renderToMap(_entities.Player.y, _entities.Player.x) 
    end
    
    map(0, 0, 0, 0, 32,32)

    level:RenderVisibilityMap()
    pset(_entities.Player.x*1, _entities.Player.y*1, 10)
    entities_draw()
end

__gfx__
000155000001550000155000000000000000000055d5565555551515000000000000000000000000000000000000000000000000000000000000000000000000
00015a0000015a000015a00000000000000000005000000650000005000000000000000000000000000000000000000000000000000010000000000000000000
00d75500001566650d75500000000000000000005071000610000005000000000000000000000000000000000000000000000000000050000000000000000000
041566600046ccc60159650000000000000000005066100650000005000000000000000000000000000000000000000000000000000150000000000000000000
00425cc60446ccc60929aaaa00000000000000005066610650000005000000000000000000000000000000000000000000030000000550000000000000000000
04295c6600956cc60559c55000000000000000005066660610000001000000000000000000000000000000000000000030300000000510000000000000000000
0556a66001a56c655555650000000000000000005000000650000005000000000000000000000000000000000000000003000000000500000000000000000000
55555a6001a55660555655000000000000000000d565666655555551000000000000000000000000000000000000000003000000000100000000000000000000
28066082280660822806608220055002200550022005500200011000000110000001100000000000000000000000000000000000000000000000000000000000
00655600006556000065560000511500005115000051150000100100001001000010010000000000000000000000000000000000000000000000000000000000
06555560065555600651156005111150051111500510015001000010010000100100001000000000000000000000000000000000000000000000000000000000
65566556655115566510015651155115511001155100001510000001100000011000000100000000000000000000000000000000000000000000000000000000
65566556655115566510015651155115511001155100001510000001100000011000000100000000000000000000000000000000000000000000000000000000
06555560065555600651156005111150051111500510015001000010010000100100001000000000000000000000000000000000000000000000000000000000
00655600006556000065560000511500005115000051150000100100001001000010010000000000000000000000000000000000000000000000000000000000
28066082280660822806608220055002200550022005500200011000000110000001100000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000006006000600600070000007000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000007007000700700007000070075555700000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000007667000766700007755770757877570000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000007877000787700000787700000770000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000760000077500000077000000990000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000007767700a977000000099000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000006677000067000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000770000077700000000000000000000000000000000000000000000000000000000000
0556666666677550000000000000000000000000011111110000000000570d0000570d000000000000040000000978800000000029a2000004a0000003000000
56646111663636750000000000000000000000001133333300000000055705d0055705d00000000000090000000297980000000024900000494a00003bb00000
6644666166666667000000000011110000000000133ccccc00110010055705500557055000000000004940000000827800000000024000002949000033300000
646461116666666600000000001331000000000013cc3ccc000000005557055d5557055d00000000499799400000029800000000002000000224000003000000
626461666666666600000000001331000000000013cccccc00001000550000555549945500000000004940000000089800000000000000000000000000000000
626661116666666600000000001131000000000013ccc3cc001000005082280558a22a8500000000000900000000828000000000000000000000000000000000
642666666666664600000000000011000000000013cccc7c00000100505555055095590500000000000400000002280000000000000000000000000000000000
642666666666664600000000000000000000000013cccccc00000000000000000000000000000000000000000008200000000000000000000000000000000000
6466666c16666646000000000000000000000000000c100000000000000000005151151d00000000000000000000000055660000556600005566000055660000
646666c16661664600000000000000000000000000c10001000000000000000005571550000000000004000000000000d31d0000db3d0000d33d0000d33d0000
626661c166c6662600000000000000000000000001c100c0000000000000000000575500000000000009000000000000db3d0000dbbd0000db3d0000d33d0000
626661c16716662600000000000000000000000001c10710000000000000000000570505000000000497940000000000dddd0000dddd0000dddd0000dddd0000
626661c16716662600000000000000000000000001c1071000000000000000005057000000000000000900000000000000000000000000000000000000000000
626661c166c6662600000000000000000000000001c100c000000000000000000050050000000000000400000000000000000000000000000000000000000000
626666c16661662600000000000000000000000000c1000100000000000000000050000000000000000000000000000000000000000000000000000000000000
6266666c16666626000000000000000000000000000c100000000000000000000050000000000000000000000000000000000000000000000000000000000000
62666666666666260000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
646666666666664600000000000000000000000000000000000000000000000000000000000000000000000000000000000c1000000000000000000000000000
6466666666666646000000000000000000000000000000000000000000000000000000000000000000040000000000000cc11110000000000000000000000000
6266666666666666000000000000000000000000000000000000000000000000000000000000000000494000000000000ce11e10000000000000000000000000
64611111666666660000000000000000000000000000000000000000000000000000000000000000000400000000000000c11100000000000000000000000000
646166616666666600000000000000000000000000000000000000000000000000000000000000000000000000000000000cc000000000000000000000000000
56616161661116650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05566666666665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
